<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibeplot</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><polygon points='32,8 56,22 56,46 32,60 8,46 8,22' fill='%234a9eff'/><polygon points='32,8 56,22 32,36 8,22' fill='%2366b3ff'/><polygon points='8,22 32,36 32,60 8,46' fill='%23ff6b6b'/><polygon points='56,22 56,46 32,60 32,36' fill='%2351cf66'/></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #1a1a1a;
        }
        .container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        #debug-panel {
            display: none;
            position: absolute;
            top: 95px;
            left: 10px;
            color: #ccc;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
            background: rgba(37, 37, 38, 0.9);
            border: 1px solid #454545;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            white-space: pre;
            line-height: 1.5;
        }
        #debug-panel:hover {
            background: rgba(60, 60, 60, 0.95);
            border-color: #666;
        }
        #debug-hint {
            position: absolute;
            top: 95px;
            left: 10px;
            color: #888;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 12px;
            background: rgba(37, 37, 38, 0.9);
            border: 1px solid #454545;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
        }
        #ws-status {
            display: none;
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #888;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 11px;
            background: rgba(37, 37, 38, 0.9);
            border: 1px solid #454545;
            padding: 6px 10px;
            border-radius: 4px;
        }
        #ws-status.connected {
            color: #4ec9b0;
            border-color: #2d6b5a;
        }
        /* Tab bar */
        #tab-bar {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            height: 35px;
            background: rgba(30, 30, 30, 0.95);
            border-bottom: 1px solid #454545;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 13px;
            overflow-x: auto;
            z-index: 100;
        }
        #tab-bar::-webkit-scrollbar {
            height: 3px;
        }
        #tab-bar::-webkit-scrollbar-thumb {
            background: #454545;
        }
        .tab {
            display: flex;
            align-items: center;
            padding: 0 12px;
            height: 100%;
            color: #888;
            border-right: 1px solid #454545;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }
        .tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #ccc;
        }
        .tab.active {
            background: rgba(37, 37, 38, 0.9);
            color: #fff;
            border-bottom: 2px solid #007acc;
            margin-bottom: -1px;
        }
        .tab-name {
            margin-right: 8px;
        }
        .tab-close {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.15s, background 0.15s;
        }
        .tab:hover .tab-close {
            opacity: 0.7;
        }
        .tab-close:hover {
            opacity: 1 !important;
            background: rgba(255, 255, 255, 0.1);
        }
        .tab-add {
            padding: 0 12px;
            height: 100%;
            display: flex;
            align-items: center;
            color: #888;
            cursor: pointer;
            font-size: 18px;
        }
        .tab-add:hover {
            color: #ccc;
            background: rgba(255, 255, 255, 0.05);
        }
        /* Add Figure dialog */
        #add-figure-dialog {
            display: none;
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 90%;
            background: #252526;
            border: 1px solid #454545;
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            z-index: 1001;
            overflow: hidden;
        }
        #add-figure-dialog.visible {
            display: block;
        }
        #add-figure-dialog label {
            display: block;
            padding: 12px 16px 8px;
            color: #ccc;
            font-size: 13px;
        }
        #figure-name-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: #3c3c3c;
            color: #fff;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
        }
        #figure-name-input::placeholder {
            color: #888;
        }
        #add-figure-hint {
            padding: 8px 16px 12px;
            color: #888;
            font-size: 12px;
        }
        #debug-hint:hover {
            background: rgba(60, 60, 60, 0.95);
            border-color: #666;
        }
        #command-palette {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            max-width: 90%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            z-index: 1000;
        }
        #command-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 14px;
            background: rgba(37, 37, 38, 0.9);
            border: 1px solid #454545;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        #command-trigger:hover {
            background: rgba(60, 60, 60, 0.95);
            border-color: #666;
        }
        #command-trigger.hidden {
            display: none;
        }
        #command-trigger-text {
            color: #888;
            font-size: 13px;
        }
        #command-trigger-shortcut {
            color: #666;
            font-size: 11px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        #command-dropdown {
            display: none;
            background: #252526;
            border: 1px solid #007acc;
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        #command-dropdown.visible {
            display: block;
        }
        #command-input {
            width: 100%;
            padding: 8px 14px;
            border: none;
            background: #3c3c3c;
            color: #fff;
            font-size: 13px;
            outline: none;
            box-sizing: border-box;
        }
        #command-input::placeholder {
            color: #888;
        }
        #command-list {
            max-height: 250px;
            overflow-y: auto;
            border-top: 1px solid #454545;
        }
        .command-item {
            padding: 9px 14px;
            color: #ccc;
            cursor: pointer;
            font-size: 13px;
        }
        .command-item:hover,
        .command-item.selected {
            background: #094771;
            color: #fff;
        }
        .command-item .match {
            color: #18a3ff;
            font-weight: bold;
        }
        #url-input-dialog {
            display: none;
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 500px;
            max-width: 90%;
            background: #252526;
            border: 1px solid #454545;
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            z-index: 1001;
            overflow: hidden;
        }
        #url-input-dialog.visible {
            display: block;
        }
        #url-input-dialog label {
            display: block;
            padding: 12px 16px 8px;
            color: #ccc;
            font-size: 13px;
        }
        #url-input {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: #3c3c3c;
            color: #fff;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
        }
        #url-input::placeholder {
            color: #888;
        }
        #url-input-hint {
            padding: 8px 16px 12px;
            color: #888;
            font-size: 12px;
        }
        #error-message {
            display: none;
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 90%;
            background: #5a1d1d;
            border: 1px solid #8b3a3a;
            border-radius: 6px;
            padding: 16px 20px;
            color: #ff9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            z-index: 1002;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        #error-message.visible {
            display: block;
        }
        #error-message .error-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #ffcccc;
        }
        #generate-model-dialog {
            display: none;
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 700px;
            max-width: 95%;
            max-height: 90vh;
            background: #252526;
            border: 1px solid #454545;
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            z-index: 1001;
            overflow: hidden;
            display: none;
            flex-direction: column;
        }
        #generate-model-dialog.visible {
            display: flex;
        }
        #generate-model-dialog .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #333;
            border-bottom: 1px solid #454545;
        }
        #generate-model-dialog .dialog-title {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        #generate-model-dialog .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0 4px;
        }
        #generate-model-dialog .close-btn:hover {
            color: #fff;
        }
        #generate-model-dialog .dialog-content {
            padding: 16px;
            overflow-y: auto;
            flex: 1;
        }
        #generate-model-dialog .section {
            margin-bottom: 16px;
        }
        #generate-model-dialog .section-title {
            color: #ccc;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        #generate-model-dialog .format-spec {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            padding: 12px;
            font-family: monospace;
            font-size: 12px;
            color: #d4d4d4;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
        #generate-model-dialog .prompt-area {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 14px;
            color: #d4d4d4;
            resize: vertical;
            outline: none;
        }
        #generate-model-dialog .prompt-area:focus {
            border-color: #007acc;
        }
        #generate-model-dialog .model-output {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: #d4d4d4;
            resize: vertical;
            outline: none;
        }
        #generate-model-dialog .model-output:focus {
            border-color: #007acc;
        }
        #generate-model-dialog .button-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        #generate-model-dialog .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #generate-model-dialog .btn-primary {
            background: #0e639c;
            color: #fff;
        }
        #generate-model-dialog .btn-primary:hover {
            background: #1177bb;
        }
        #generate-model-dialog .btn-secondary {
            background: #3c3c3c;
            color: #ccc;
        }
        #generate-model-dialog .btn-secondary:hover {
            background: #4c4c4c;
        }
        #generate-model-dialog .hint {
            color: #888;
            font-size: 12px;
            margin-top: 6px;
        }
        #generate-model-dialog .copy-feedback {
            color: #4ec9b0;
            font-size: 12px;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #generate-model-dialog .copy-feedback.visible {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <canvas id="canvas"></canvas>
        <div id="debug-panel"></div>
        <div id="ws-status">Python: disconnected</div>
        <div id="debug-hint">Tap or press / for debug panel</div>
        <div id="command-palette">
            <div id="command-trigger">
                <span id="command-trigger-text">Commands...</span>
                <span id="command-trigger-shortcut">⌘⇧P</span>
            </div>
            <div id="command-dropdown">
                <input type="text" id="command-input" placeholder="Search commands..." autocomplete="off" />
                <div id="command-list"></div>
            </div>
        </div>
        <div id="tab-bar">
            <div class="tab-add" id="tab-add-btn" title="Add Figure (Cmd+T)">+</div>
        </div>
        <div id="url-input-dialog">
            <label>Enter model URL:</label>
            <input type="text" id="url-input" placeholder="https://example.com/model.txt" autocomplete="off" />
            <div id="url-input-hint">Press Enter to load, Escape to cancel</div>
        </div>
        <div id="add-figure-dialog">
            <label>Figure name:</label>
            <input type="text" id="figure-name-input" placeholder="Figure 1" autocomplete="off" />
            <div id="add-figure-hint">Press Enter to create, Escape to cancel</div>
        </div>
        <div id="error-message">
            <div class="error-title">Error loading model</div>
            <div id="error-text"></div>
        </div>
        <div id="generate-model-dialog">
            <div class="dialog-header">
                <span class="dialog-title">Generate Model with AI</span>
                <button class="close-btn" id="generate-dialog-close">&times;</button>
            </div>
            <div class="dialog-content">
                <div class="section">
                    <div class="section-title">Model Format Specification</div>
                    <div class="format-spec"># Model File Format
# Lines starting with # are comments

# Vertex format: vertex x y z nx ny nz r g b
#   x y z = position
#   nx ny nz = normal vector
#   r g b = color (0.0 to 1.0)

# Face format: face i0 i1 i2
#   Three vertex indices (0-indexed)

# Example: A colorful triangle
vertex  0.0  0.5  0.0   0.0 0.0 1.0   1.0 0.0 0.0
vertex -0.5 -0.5  0.0   0.0 0.0 1.0   0.0 1.0 0.0
vertex  0.5 -0.5  0.0   0.0 0.0 1.0   0.0 0.0 1.0
face 0 1 2</div>
                </div>
                <div class="section">
                    <div class="section-title">Prompt for AI <span class="copy-feedback" id="copy-feedback">Copied!</span></div>
                    <textarea class="prompt-area" id="generate-prompt">Generate a 3D model in the following format:

- Each vertex line: vertex x y z nx ny nz r g b
  (position, normal vector, RGB color 0-1)
- Each face line: face i0 i1 i2
  (three 0-indexed vertex indices, counter-clockwise winding)

Create a [DESCRIBE YOUR MODEL HERE - e.g., "pyramid with a red base and yellow tip" or "low-poly sphere with rainbow colors"].

Output only the model data, no explanations. Start with vertices, then faces.</textarea>
                    <div class="button-row">
                        <button class="btn btn-secondary" id="copy-prompt-btn">Copy Prompt</button>
                    </div>
                    <div class="hint">Copy this prompt, modify the description in brackets, and paste into your AI assistant.</div>
                </div>
                <div class="section">
                    <div class="section-title">Paste Generated Model</div>
                    <textarea class="model-output" id="generated-model-input" placeholder="Paste the AI-generated model here..."></textarea>
                    <div class="button-row">
                        <button class="btn btn-primary" id="load-generated-btn">Load Model</button>
                        <button class="btn btn-secondary" id="clear-generated-btn">Clear</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="model-file-input" accept=".txt,.model" style="display: none;" />
    <script type="module">
        import init, { reset_zoom, reset_rotation, load_model, load_cube_model, load_pyramid_model, get_rotation, set_rotation, get_zoom, set_zoom } from './pkg/vibeplot.js';

        // WebSocket connection to Python client
        let ws = null;
        let wsReconnectTimer = null;
        const WS_URL = 'ws://localhost:9753';
        const WS_RECONNECT_DELAY = 2000;

        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) return;

            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = () => {
                    console.log('vibeplot: Connected to Python client');
                    if (wsReconnectTimer) {
                        clearInterval(wsReconnectTimer);
                        wsReconnectTimer = null;
                    }
                    // Tell Python we're ready to receive messages
                    ws.send(JSON.stringify({ type: 'ready' }));
                    // Update status indicator
                    const status = document.getElementById('ws-status');
                    status.textContent = 'Python: connected';
                    status.classList.add('connected');
                    status.style.display = 'block';
                };

                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        handlePythonMessage(msg);
                    } catch (e) {
                        console.error('vibeplot: Failed to parse message:', e);
                    }
                };

                ws.onclose = () => {
                    ws = null;
                    if (!wsReconnectTimer) {
                        wsReconnectTimer = setInterval(connectWebSocket, WS_RECONNECT_DELAY);
                    }
                    // Update status indicator
                    const status = document.getElementById('ws-status');
                    status.textContent = 'Python: disconnected';
                    status.classList.remove('connected');
                };

                ws.onerror = () => {
                    ws = null;
                };
            } catch (e) {
                // WebSocket constructor can throw
            }
        }

        function handlePythonMessage(msg) {
            let success = true;
            let error = null;

            try {
                switch (msg.type) {
                    case 'load_model':
                        loadModelToActiveFigure(msg.data);
                        console.log('vibeplot: Model loaded from Python');
                        break;
                    case 'reset_zoom':
                        reset_zoom();
                        break;
                    case 'reset_rotation':
                        reset_rotation();
                        break;
                    case 'ping':
                        break;
                    default:
                        console.warn('vibeplot: Unknown message type:', msg.type);
                }
            } catch (e) {
                success = false;
                error = e.toString();
                console.error('vibeplot: Error handling message:', e);
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'ack', success, error }));
            }
        }

        // Figure management
        const figures = [];
        let activeFigureIndex = -1;
        let figureCounter = 0;

        const DEFAULT_ROTATION_X = -0.5;
        const DEFAULT_ROTATION_Y = 0.7;
        const DEFAULT_ZOOM = 1.0;

        function createFigure(name, modelText = null) {
            const figure = {
                id: ++figureCounter,
                name: name || `Figure ${figureCounter}`,
                modelText: modelText,
                rotationX: DEFAULT_ROTATION_X,
                rotationY: DEFAULT_ROTATION_Y,
                zoom: DEFAULT_ZOOM
            };
            figures.push(figure);
            return figures.length - 1;
        }

        function saveCurrentFigureState() {
            if (activeFigureIndex >= 0 && activeFigureIndex < figures.length) {
                const rotation = get_rotation();
                figures[activeFigureIndex].rotationX = rotation[0];
                figures[activeFigureIndex].rotationY = rotation[1];
                figures[activeFigureIndex].zoom = get_zoom();
            }
        }

        function restoreFigureState(index) {
            if (index >= 0 && index < figures.length) {
                const figure = figures[index];
                set_rotation(figure.rotationX, figure.rotationY);
                set_zoom(figure.zoom);
            }
        }

        function loadFigureModel(index) {
            if (index >= 0 && index < figures.length) {
                const figure = figures[index];
                if (figure.modelText) {
                    load_model(figure.modelText);
                } else {
                    load_cube_model();
                }
            }
        }

        function switchToFigure(index) {
            if (index < 0 || index >= figures.length || index === activeFigureIndex) {
                return;
            }
            saveCurrentFigureState();
            activeFigureIndex = index;
            loadFigureModel(index);
            restoreFigureState(index);
            renderTabs();
        }

        function addFigure(name) {
            saveCurrentFigureState();
            const index = createFigure(name);
            activeFigureIndex = index;
            load_cube_model();
            set_rotation(figures[index].rotationX, figures[index].rotationY);
            set_zoom(figures[index].zoom);
            renderTabs();
        }

        function closeFigure(index) {
            if (figures.length <= 1) {
                return;
            }
            figures.splice(index, 1);
            if (activeFigureIndex >= figures.length) {
                activeFigureIndex = figures.length - 1;
            } else if (index < activeFigureIndex) {
                activeFigureIndex--;
            } else if (index === activeFigureIndex) {
                loadFigureModel(activeFigureIndex);
                restoreFigureState(activeFigureIndex);
            }
            renderTabs();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderTabs() {
            const tabBar = document.getElementById('tab-bar');
            const addBtn = document.getElementById('tab-add-btn');
            const existingTabs = tabBar.querySelectorAll('.tab');
            existingTabs.forEach(tab => tab.remove());

            figures.forEach((figure, index) => {
                const tab = document.createElement('div');
                tab.className = `tab${index === activeFigureIndex ? ' active' : ''}`;
                tab.dataset.index = index;
                tab.innerHTML = `
                    <span class="tab-name">${escapeHtml(figure.name)}</span>
                    <span class="tab-close" title="Close">\u00d7</span>
                `;
                tabBar.insertBefore(tab, addBtn);
            });
        }

        function loadModelToActiveFigure(modelText) {
            if (activeFigureIndex >= 0 && activeFigureIndex < figures.length) {
                figures[activeFigureIndex].modelText = modelText;
            }
            load_model(modelText);
        }

        function showAddFigureDialog() {
            const dialog = document.getElementById('add-figure-dialog');
            const input = document.getElementById('figure-name-input');
            dialog.classList.add('visible');
            input.value = `Figure ${figureCounter + 1}`;
            input.focus();
            input.select();
        }

        function hideAddFigureDialog() {
            const dialog = document.getElementById('add-figure-dialog');
            dialog.classList.remove('visible');
        }

        function loadModelFromFile() {
            const input = document.getElementById('model-file-input');
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            loadModelToActiveFigure(event.target.result);
                            console.log('Model loaded successfully');
                        } catch (err) {
                            showError('Failed to load model: ' + err);
                        }
                    };
                    reader.readAsText(file);
                }
                input.value = ''; // Reset for next use
            };
            input.click();
        }

        function showUrlDialog() {
            const dialog = document.getElementById('url-input-dialog');
            const input = document.getElementById('url-input');
            dialog.classList.add('visible');
            input.value = '';
            input.focus();
        }

        function hideUrlDialog() {
            const dialog = document.getElementById('url-input-dialog');
            dialog.classList.remove('visible');
        }

        function showError(message) {
            const errorBox = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            errorText.textContent = message;
            errorBox.classList.add('visible');
            setTimeout(() => {
                errorBox.classList.remove('visible');
            }, 5000);
        }

        async function loadModelFromUrl(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const text = await response.text();
                loadModelToActiveFigure(text);
                console.log('Model loaded successfully from URL');
            } catch (err) {
                showError(err.message);
            }
        }

        // URL input event handlers
        document.getElementById('url-input').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                hideUrlDialog();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const url = e.target.value.trim();
                if (url) {
                    hideUrlDialog();
                    loadModelFromUrl(url);
                }
            }
        });

        // Generate Model dialog functions
        function showGenerateDialog() {
            const dialog = document.getElementById('generate-model-dialog');
            dialog.classList.add('visible');
        }

        function hideGenerateDialog() {
            const dialog = document.getElementById('generate-model-dialog');
            dialog.classList.remove('visible');
        }

        // Generate Model dialog event handlers
        document.getElementById('generate-dialog-close').addEventListener('click', hideGenerateDialog);

        document.getElementById('copy-prompt-btn').addEventListener('click', () => {
            const prompt = document.getElementById('generate-prompt');
            prompt.select();
            navigator.clipboard.writeText(prompt.value).then(() => {
                const feedback = document.getElementById('copy-feedback');
                feedback.classList.add('visible');
                setTimeout(() => feedback.classList.remove('visible'), 2000);
            });
        });

        document.getElementById('load-generated-btn').addEventListener('click', () => {
            const modelText = document.getElementById('generated-model-input').value.trim();
            if (!modelText) {
                showError('Please paste a model first');
                return;
            }
            try {
                loadModelToActiveFigure(modelText);
                hideGenerateDialog();
                console.log('Generated model loaded successfully');
            } catch (err) {
                showError('Failed to load model: ' + err);
            }
        });

        document.getElementById('clear-generated-btn').addEventListener('click', () => {
            document.getElementById('generated-model-input').value = '';
        });

        document.getElementById('generate-model-dialog').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                hideGenerateDialog();
            }
        });

        const commands = [
            { id: 'add-figure', label: 'Add Figure', action: () => showAddFigureDialog() },
            { id: 'generate-model', label: 'Generate Model', action: () => showGenerateDialog() },
            { id: 'load-model-disk', label: 'Load Model from disk', action: () => loadModelFromFile() },
            { id: 'load-model-url', label: 'Load Model from URL', action: () => showUrlDialog() },
            { id: 'load-cube', label: 'Load Cube Model', action: () => load_cube_model() },
            { id: 'load-pyramid', label: 'Load Pyramid Model', action: () => load_pyramid_model() },
            { id: 'reset-zoom', label: 'Reset Zoom', action: () => reset_zoom() },
            { id: 'reset-rotation', label: 'Reset Rotation', action: () => reset_rotation() },
        ];

        let selectedIndex = 0;
        let filteredCommands = [...commands];

        function fuzzyMatch(text, query) {
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase();
            let textIndex = 0;
            let matchIndices = [];

            for (let i = 0; i < lowerQuery.length; i++) {
                const char = lowerQuery[i];
                const foundIndex = lowerText.indexOf(char, textIndex);
                if (foundIndex === -1) return null;
                matchIndices.push(foundIndex);
                textIndex = foundIndex + 1;
            }
            return matchIndices;
        }

        function highlightMatches(text, matchIndices) {
            if (!matchIndices) return text;
            let result = '';
            let lastIndex = 0;
            for (const idx of matchIndices) {
                result += text.slice(lastIndex, idx);
                result += `<span class="match">${text[idx]}</span>`;
                lastIndex = idx + 1;
            }
            result += text.slice(lastIndex);
            return result;
        }

        function renderCommands() {
            const list = document.getElementById('command-list');
            list.innerHTML = filteredCommands.map((cmd, i) => {
                const query = document.getElementById('command-input').value;
                const matchIndices = fuzzyMatch(cmd.label, query);
                const highlighted = highlightMatches(cmd.label, matchIndices);
                return `<div class="command-item${i === selectedIndex ? ' selected' : ''}" data-index="${i}">${highlighted}</div>`;
            }).join('');
        }

        function filterCommands(query) {
            if (!query) {
                filteredCommands = [...commands];
            } else {
                filteredCommands = commands.filter(cmd => fuzzyMatch(cmd.label, query));
            }
            selectedIndex = 0;
            renderCommands();
        }

        function showPalette() {
            const trigger = document.getElementById('command-trigger');
            const dropdown = document.getElementById('command-dropdown');
            const input = document.getElementById('command-input');
            trigger.classList.add('hidden');
            dropdown.classList.add('visible');
            input.value = '';
            filterCommands('');
            input.focus();
        }

        function hidePalette() {
            const trigger = document.getElementById('command-trigger');
            const dropdown = document.getElementById('command-dropdown');
            trigger.classList.remove('hidden');
            dropdown.classList.remove('visible');
        }

        function togglePalette() {
            const dropdown = document.getElementById('command-dropdown');
            if (dropdown.classList.contains('visible')) {
                hidePalette();
            } else {
                showPalette();
            }
        }

        function executeSelected() {
            if (filteredCommands[selectedIndex]) {
                filteredCommands[selectedIndex].action();
                hidePalette();
            }
        }

        document.addEventListener('keydown', (e) => {
            const dropdown = document.getElementById('command-dropdown');
            const urlDialog = document.getElementById('url-input-dialog');
            const generateDialog = document.getElementById('generate-model-dialog');
            const paletteVisible = dropdown.classList.contains('visible');
            const urlDialogVisible = urlDialog.classList.contains('visible');
            const generateDialogVisible = generateDialog.classList.contains('visible');

            if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key.toLowerCase() === 'p') {
                e.preventDefault();
                hideUrlDialog();
                hideGenerateDialog();
                togglePalette();
                return;
            }

            // Other dialogs are handled by their own listeners
            if (urlDialogVisible || generateDialogVisible) return;

            if (!paletteVisible) return;

            if (e.key === 'Escape') {
                e.preventDefault();
                hidePalette();
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, filteredCommands.length - 1);
                renderCommands();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                renderCommands();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                executeSelected();
            }
        });

        document.getElementById('command-input').addEventListener('input', (e) => {
            filterCommands(e.target.value);
        });

        document.getElementById('command-trigger').addEventListener('click', () => {
            togglePalette();
        });

        document.getElementById('command-list').addEventListener('click', (e) => {
            const item = e.target.closest('.command-item');
            if (item) {
                selectedIndex = parseInt(item.dataset.index);
                executeSelected();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const palette = document.getElementById('command-palette');
            const dropdown = document.getElementById('command-dropdown');
            if (!palette.contains(e.target) && dropdown.classList.contains('visible')) {
                hidePalette();
            }
        });

        document.getElementById('error-message').addEventListener('click', () => {
            document.getElementById('error-message').classList.remove('visible');
        });

        // Toggle debug panel on tap (for mobile)
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const hint = document.getElementById('debug-hint');
            const panelDisplay = getComputedStyle(panel).display;
            if (panelDisplay === 'none') {
                panel.style.display = 'block';
                hint.style.display = 'none';
            } else {
                panel.style.display = 'none';
                hint.style.display = 'block';
            }
        }

        document.getElementById('debug-panel').addEventListener('click', toggleDebugPanel);
        document.getElementById('debug-hint').addEventListener('click', toggleDebugPanel);

        // Tab bar event handlers
        document.getElementById('tab-bar').addEventListener('click', (e) => {
            const closeBtn = e.target.closest('.tab-close');
            if (closeBtn) {
                const tab = closeBtn.closest('.tab');
                const index = parseInt(tab.dataset.index);
                closeFigure(index);
                return;
            }
            const tab = e.target.closest('.tab');
            if (tab && !tab.classList.contains('tab-add')) {
                const index = parseInt(tab.dataset.index);
                switchToFigure(index);
            }
        });

        document.getElementById('tab-add-btn').addEventListener('click', () => {
            showAddFigureDialog();
        });

        // Add Figure dialog event handler
        document.getElementById('figure-name-input').addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                hideAddFigureDialog();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const name = e.target.value.trim();
                if (name) {
                    hideAddFigureDialog();
                    addFigure(name);
                }
            }
        });

        // Cmd+T keyboard shortcut for adding figures
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 't') {
                e.preventDefault();
                showAddFigureDialog();
            }
        });

        async function run() {
            if (!navigator.gpu) {
                alert('WebGPU is not supported in this browser. Please use Chrome 113+ or Edge 113+.');
                return;
            }
            await init();

            // Initialize first figure
            addFigure('Figure 1');

            // Start WebSocket connection to Python client after WASM is ready
            connectWebSocket();
            wsReconnectTimer = setInterval(connectWebSocket, WS_RECONNECT_DELAY);
        }

        run();
    </script>
</body>
</html>
